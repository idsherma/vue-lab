<h1>Last Call Webpack Plugin</h1>

<p>A Webpack plugin that allows you to transform \ modify assets just before Webpack emits them.</p>

<h2>What does the plugin do?</h2>

<p>It allows you to transform \ modify Webpack assets just before Webpack emits them (writes them to files or memory in case you are using something like Webpack dev server).</p>

<p>It can be used for example to:
* Prefix a <code>/* Author: John Doe */</code> comment on all the .js files Webpack generates.
* Run some final optimization on all .css files Webpack generates.</p>

<h2>Installation:</h2>

<p>Using npm:
<code>shell
$ npm install --save-dev last-call-webpack-plugin
</code></p>

<h2>Configuration:</h2>

<p>The plugin can receive the following options:
* assetProcessors: An Array of objects that describe asset processors:
  * regExp: A regular expression to match the asset name that the processor handles.
  * processor: A function with the signature of <code>function(assetName, webpackAssetObject, assets)</code> that returns a Promise. If the Promise returns a result this result will replace the assets content.
  * phase: The webpack compilation phase that at which the processor should be called. Default value is <code>compilation.optimize-assets</code>. Can be one of the following values:
    * <code>compilation.optimize-chunk-assets</code>
    * <code>compilation.optimize-assets</code>
    * <code>emit</code>
* onStart: A function with the signature of <code>function(assets, assetsAndProcessors, webpackCompilationObject)</code> that will be called before the plugin starts calling the assets processors.
* onEnd: A function with the signature of <code>function(error)</code> that will be called after the plugin calls all the assets processors. If no errors occurred the <code>error</code> parameter will be undefined.
* canPrint: A boolean indicating if the plugin can print messages to the console, defaults to <code>true</code>.</p>

<p>Note: An environment supporting Promises or a Promise polyfill is needed for this plugin to be used.</p>

<h2>Example:</h2>

<p><code>javascript
var cssnano = require('cssnano');
var LastCallWebpackPlugin = require('last-call-webpack-plugin');
module.exports = {
  module: {
    loaders: [
      { test: /\.css$/, loader: ExtractTextPlugin.extract("style-loader", "css-loader") }
    ]
  },
  plugins: [
    new ExtractTextPlugin("styles.css"),
    new LastCallWebpackPlugin({
      assetProcessors: [{
        regExp:  /\.js$/,
        processor: (assetName, asset) => Promise.resolve('// Author: John Doe \n' + asset.source())
      }, {
        regExp:  /\.css$/,
        processor: (assetName, asset) => cssnano.process(asset.source())
          .then(r => r.css)
      }],
      onStart: () => console.log('Starting to process assets.'),
      onEnd: (err) => console.log(err ? 'Error: ' + err : 'Finished processing assets.'),
      canPrint: true
    })
	]
}
</code></p>

<h2>Assets manipulation</h2>

<p>The <code>processor</code> method is supplied an <code>assets</code> object that allows asset manipulation via the <code>setAsset(assetName, assetValue)</code> method. If <code>assetValue</code> is null the asset will be deleted. This object can be used to generate aditional assets (like source maps) or rename the an asset (create a new asset and delete the current one).</p>

<p>Example:</p>

<p><code>javascript
var cssnano = require('cssnano');
var LastCallWebpackPlugin = require('last-call-webpack-plugin');
module.exports = {
  module: {
    loaders: [
      { test: /\.css$/, loader: ExtractTextPlugin.extract("style-loader", "css-loader") }
    ]
  },
  plugins: [
    new ExtractTextPlugin("styles.css"),
    new LastCallWebpackPlugin({
      assetProcessors: [{
        regExp:  /\.css$/,
        processor: (assetName, asset, assets) => {
          assets.setAsset(assetName + '.map', null); // Delete the <assetName>.map asset.
          assets.setAsset(assetName + '.log', 'All OK'); // Add the <assetName>.log asset with the content 'All OK'.
          return cssnano
            .process(asset.source())
            .then(r => r.css)
        }
      }],
      onStart: () => console.log('Starting to process assets.'),
      onEnd: (err) => console.log(err ? 'Error: ' + err : 'Finished processing assets.'),
      canPrint: true
    })
	]
}
</code></p>

<p>The <code>assets</code> object also has a <code>getAsset(assetName)</code> method to get the content of an asset (returns undefined in case the asset does not exist).</p>

<h2>License</h2>

<p>MIT (http://www.opensource.org/licenses/mit-license.php)</p>