<h1 align="center">connect-history-api-fallback</h1>
<p align="center">Middleware to proxy requests through a specified index page, useful for Single Page Applications that utilise the HTML5 History API.</p>

<p><a href="https://travis-ci.org/bripkens/connect-history-api-fallback"><img src="https://travis-ci.org/bripkens/connect-history-api-fallback.svg?branch=master" alt="Build Status" /></a>
<a href="https://david-dm.org/bripkens/connect-history-api-fallback/master"><img src="https://david-dm.org/bripkens/connect-history-api-fallback/master.svg" alt="Dependency Status" /></a></p>

<p><a href="https://nodei.co/npm/connect-history-api-fallback/"><img src="https://nodei.co/npm/connect-history-api-fallback.png?downloads=true&downloadRank=true" alt="NPM" /></a></p>

<h2>Table of Contents</h2>

<!-- TOC depthFrom:2 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#usage">Usage</a></li>
  <li><a href="#options">Options</a>
    <ul>
      <li><a href="#index">index</a></li>
      <li><a href="#rewrites">rewrites</a></li>
      <li><a href="#verbose">verbose</a></li>
      <li><a href="#htmlacceptheaders">htmlAcceptHeaders</a></li>
      <li><a href="#disabledotrule">disableDotRule</a></li>
    </ul>
  </li>
</ul>

<!-- /TOC -->

<h2>Introduction</h2>

<p>Single Page Applications (SPA) typically only utilise one index file that is
accessible by web browsers: usually <code>index.html</code>. Navigation in the application
is then commonly handled using JavaScript with the help of the
<a href="http://www.w3.org/html/wg/drafts/html/master/single-page.html#the-history-interface">HTML5 History API</a>.
This results in issues when the user hits the refresh button or is directly
accessing a page other than the landing page, e.g. <code>/help</code> or <code>/help/online</code>
as the web server bypasses the index file to locate the file at this location.
As your application is a SPA, the web server will fail trying to retrieve the file and return a <em>404 - Not Found</em>
message to the user.</p>

<p>This tiny middleware addresses some of the issues. Specifically, it will change
the requested location to the index you specify (default being <code>/index.html</code>)
whenever there is a request which fulfills the following criteria:</p>

<ol>
  <li>The request is a GET request</li>
  <li>which accepts <code>text/html</code>,</li>
  <li>is not a direct file request, i.e. the requested path does not contain a
<code>.</code> (DOT) character and</li>
  <li>does not match a pattern provided in options.rewrites (see options below)</li>
</ol>

<h2>Usage</h2>

<p>The middleware is available through NPM and can easily be added.</p>

<p><code>
npm install --save connect-history-api-fallback
</code></p>

<p>Import the library</p>

<p><code>javascript
var history = require('connect-history-api-fallback');
</code></p>

<p>Now you only need to add the middleware to your application like so</p>

<p>```javascript
var connect = require(‘connect’);</p>

<p>var app = connect()
  .use(history())
  .listen(3000);
```</p>

<p>Of course you can also use this piece of middleware with express:</p>

<p>```javascript
var express = require(‘express’);</p>

<p>var app = express();
app.use(history());
```</p>

<h2>Options</h2>
<p>You can optionally pass options to the library when obtaining the middleware</p>

<p><code>javascript
var middleware = history({});
</code></p>

<h3>index</h3>
<p>Override the index (default <code>/index.html</code>)</p>

<p><code>javascript
history({
  index: '/default.html'
});
</code></p>

<h3>rewrites</h3>
<p>Override the index when the request url matches a regex pattern. You can either rewrite to a static string or use a function to transform the incoming request.</p>

<p>The following will rewrite a request that matches the <code>/\/soccer/</code> pattern to <code>/soccer.html</code>.
<code>javascript
history({
  rewrites: [
    { from: /\/soccer/, to: '/soccer.html'}
  ]
});
</code></p>

<p>Alternatively functions can be used to have more control over the rewrite process. For instance, the following listing shows how requests to <code>/libs/jquery/jquery.1.12.0.min.js</code> and the like can be routed to <code>./bower_components/libs/jquery/jquery.1.12.0.min.js</code>. You can also make use of this if you have an API version in the URL path.
<code>javascript
history({
  rewrites: [
    {
      from: /^\/libs\/.*$/,
      to: function(context) {
        return '/bower_components' + context.parsedUrl.pathname;
      }
    }
  ]
});
</code></p>

<p>The function will always be called with a context object that has the following properties:</p>

<ul>
  <li><strong>parsedUrl</strong>: Information about the URL as provided by the <a href="https://nodejs.org/api/url.html#url_url_parse_urlstr_parsequerystring_slashesdenotehost">URL module’s</a> <code>url.parse</code>.</li>
  <li><strong>match</strong>: An Array of matched results as provided by <code>String.match(...)</code>.</li>
  <li><strong>request</strong>: The HTTP request object.</li>
</ul>

<h3>verbose</h3>
<p>This middleware does not log any information by default. If you wish to activate logging, then you can do so via the <code>verbose</code> option or by specifying a logger function.</p>

<p><code>javascript
history({
  verbose: true
});
</code></p>

<p>Alternatively use your own logger</p>

<p><code>javascript
history({
  logger: console.log.bind(console)
});
</code></p>

<h3>htmlAcceptHeaders</h3>
<p>Override the default <code>Accepts:</code> headers that are queried when matching HTML content requests (Default: <code>['text/html', '*/*']</code>).</p>

<p><code>javascript
history({
  htmlAcceptHeaders: ['text/html', 'application/xhtml+xml']
})
</code></p>

<h3>disableDotRule</h3>
<p>Disables the dot rule mentioned above:</p>

<blockquote>
  <p>[…] is not a direct file request, i.e. the requested path does not contain a <code>.</code> (DOT) character […]</p>
</blockquote>

<p><code>javascript
history({
  disableDotRule: true
})
</code></p>